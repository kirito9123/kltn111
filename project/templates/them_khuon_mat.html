<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <title>Th√™m khu√¥n m·∫∑t</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #ecf0f1;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      display: flex;
      flex: 1;
      padding: 40px;
      align-items: center;
      justify-content: center;
      gap: 50px;
    }

    .left-panel {
      flex: 1;
      text-align: left;
      max-width: 500px;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }

    .right-panel {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    h2 {
      color: #34495e;
      margin-bottom: 25px;
      font-size: 2.2rem;
    }

    input {
      padding: 12px;
      margin: 10px 0;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    label {
      font-weight: bold;
      color: #555;
    }

    button {
      margin-top: 15px;
      padding: 12px 25px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s;
    }

    button#verifyButton {
      background-color: #27ae60;
      color: white;
    }

    button#verifyButton:hover {
      background-color: #219150;
    }

    button#backButton {
      background-color: #3498db;
      color: white;
    }

    button#backButton:hover {
      background-color: #2980b9;
    }

    video {
      border: 5px solid #3498db;
      border-radius: 15px;
      width: 100%;
      max-width: 640px;
      height: auto;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      display: none;
      /* ·∫®n m·∫∑c ƒë·ªãnh */
    }

    #result-container {
      width: 100%;
      text-align: center;
      padding: 20px;
      background: #f8f9fa;
      border-top: 1px solid #eee;
      min-height: 100px;
    }

    #result {
      font-weight: bold;
      color: #2c3e50;
      white-space: pre-line;
      font-size: 2rem;
      /* To c·ª° H2 */
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="left-panel">
      <h2>üì∑ Th√™m/C·∫≠p nh·∫≠t Khu√¥n m·∫∑t</h2>
      <form id="faceForm">
        <label>M√£ Nh√¢n S·ª± (mans):</label>
        <input type="text" id="mans" required placeholder="Nh·∫≠p m√£ nh√¢n s·ª±...">

        <label>H·ªç t√™n ƒë·∫ßy ƒë·ªß (Name_admin):</label>
        <input type="text" id="Name_admin" required placeholder="Nh·∫≠p h·ªç t√™n...">

        <button id="verifyButton" type="button" onclick="kiemTraVaBatCamera()">üé• X√°c minh & Ch·ª•p ·∫¢nh</button>
        <button id="backButton" type="button" onclick="quayLai()">üîô Quay l·∫°i</button>
      </form>
    </div>

    <div class="right-panel">
      <video id="video" autoplay></video>
    </div>
  </div>

  <div id="result-container">
    <div id="result"></div>
  </div>

  <script>
    let streamStarted = false;
    let fetched_id_admin = null;
    const video = document.getElementById('video');
    const resultP = document.getElementById('result');
    const verifyBtn = document.getElementById('verifyButton');

    // Danh s√°ch c√°c th·ª≠ th√°ch liveness (Ti·∫øng Vi·ªát) - Ch·ªâ d√πng Frontal cho ƒëƒÉng k√Ω
    const challenges = [
      { type: 'blink', text: 'Vui l√≤ng CH·ªöP M·∫ÆT (Blink)' },
      { type: 'smile', text: 'Vui l√≤ng C∆Ø·ªúI T∆Ø∆†I (Smile ho·∫∑c h√° mi·ªáng to ra) v√† nh√¨n th·∫≥ng v√†o camera' }
    ];

    function kiemTraVaBatCamera() {
      const mans_input = document.getElementById('mans').value.trim();
      const name_admin_input = document.getElementById('Name_admin').value.trim();
      fetched_id_admin = null;
      verifyBtn.disabled = true;
      resultP.style.color = "#888"; resultP.innerText = "ƒêang ki·ªÉm tra...";

      // Ki·ªÉm tra n·∫øu kh√¥ng c√≥ m√£ nh√¢n s·ª± ho·∫∑c t√™n ƒë·∫ßy ƒë·ªß
      if (!mans_input || !name_admin_input) {
        resultP.style.color = "red";
        resultP.innerText = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ Nh√¢n S·ª± v√† H·ªç t√™n!";
        verifyBtn.disabled = false;
        return;
      }

      // G·ª≠i y√™u c·∫ßu x√°c minh th√¥ng tin nh√¢n s·ª±
      fetch('/api/kiem_tra_nhansu_bang_mans', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mans: mans_input, Name_admin: name_admin_input })
      })
        .then(res => res.json())
        .then(data => {
          if (!data.exists) {
            // N·∫øu nh√¢n s·ª± kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng kh·ªõp
            resultP.style.color = "red";
            resultP.innerText = `‚ùå ${data.message || 'M√£ NS v√† H·ªç t√™n kh√¥ng kh·ªõp/t·ªìn t·∫°i'}`;
            verifyBtn.disabled = false;
            return Promise.reject('Nh√¢n s·ª± kh√¥ng h·ª£p l·ªá');
          }

          // N·∫øu nh√¢n s·ª± h·ª£p l·ªá, l·∫•y id_admin
          fetched_id_admin = data.id_admin;
          resultP.style.color = "blue";
          resultP.innerText = `‚úÖ X√°c nh·∫≠n: ${name_admin_input} (ID: ${fetched_id_admin}).\n B·∫≠t webcam...`;
          video.style.display = 'block'; // Hi·ªÉn th·ªã video

          // Kh·ªüi ƒë·ªông webcam
          return navigator.mediaDevices.getUserMedia({ video: true });
        })
        .then(stream => {
          video.srcObject = stream; // B·∫Øt ƒë·∫ßu stream video
          streamStarted = true;

          // Ch·ªù video load metadata ƒë·ªÉ tr√°nh l·ªói width/height = 0
          return new Promise(resolve => {
            video.onloadedmetadata = () => {
              resolve(); // Khi video ƒë√£ s·∫µn s√†ng
            };
          });
        })
        .then(() => {
          // B·∫Øt ƒë·∫ßu qu√° tr√¨nh ch·ª•p ·∫£nh liveness
          startLivenessCapture(name_admin_input);
        })
        .catch(err => {
          // X·ª≠ l√Ω l·ªói n·∫øu kh√¥ng x√°c minh ƒë∆∞·ª£c nh√¢n s·ª± ho·∫∑c l·ªói kh√°c
          if (err !== 'Nh√¢n s·ª± kh√¥ng h·ª£p l·ªá') {
            resultP.style.color = "red";
            resultP.innerText = "‚ùå L·ªói: " + (err.message || err);
          }
          verifyBtn.disabled = false;
          stopCamera(); // D·ª´ng camera n·∫øu c√≥ l·ªói
        });
    }


    function startLivenessCapture(name_admin) {
      // 1. Ch·ªçn ng·∫´u nhi√™n m·ªôt th·ª≠ th√°ch
      const randomChallenge = challenges[Math.floor(Math.random() * challenges.length)];
      console.log("Th·ª≠ th√°ch ƒë∆∞·ª£c ch·ªçn:", randomChallenge.type);

      // 2. Hi·ªÉn th·ªã h∆∞·ªõng d·∫´n
      resultP.style.color = "orange";
      resultP.innerText = `üì∏ ƒêang qu√©t khu√¥n m·∫∑t cho ${name_admin}...\nüëÄ ${randomChallenge.text}`;

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      const frames = [];
      const maxFrames = 8; // Ch·ª•p 8 khung h√¨nh
      const intervalTime = 200; // C√°ch nhau 200ms -> T·ªïng ~1.6s
      let count = 0;

      // 3. B·∫Øt ƒë·∫ßu ch·ª•p li√™n t·ª•c
      const captureInterval = setInterval(() => {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          if (blob) frames.push(blob);
        }, 'image/jpeg', 0.9);

        count++;
        if (count >= maxFrames) {
          clearInterval(captureInterval);
          resultP.innerText = "‚è≥ ƒêang x·ª≠ l√Ω d·ªØ li·ªáu...";
          // G·ª≠i ·∫£nh v√† lo·∫°i th·ª≠ th√°ch v·ªÅ server
          setTimeout(() => sendFrames(frames, name_admin, randomChallenge.type), 100);
        }
      }, intervalTime);
    }

    function sendFrames(frames, name_admin, challengeType) {
      if (frames.length === 0) {
        resultP.style.color = "red"; resultP.innerText = "‚ùå L·ªói: Kh√¥ng ch·ª•p ƒë∆∞·ª£c ·∫£nh n√†o!";
        verifyBtn.disabled = false;
        return;
      }

      const formData = new FormData();
      formData.append('id_admin', fetched_id_admin);
      formData.append('Name_admin', name_admin);
      // G·ª≠i lo·∫°i th·ª≠ th√°ch
      formData.append('challenge', challengeType);

      frames.forEach((blob, index) => {
        formData.append('images', blob, `frame_${index}.jpg`);
      });

      fetch('/api/them_khuon_mat', {
        method: 'POST',
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            resultP.style.color = "green";
            let countdown = 5;
            resultP.innerText = `${data.message}\nüîÅ Quay v·ªÅ trang ch·ªß sau ${countdown} gi√¢y...`;

            stopCamera();

            const interval = setInterval(() => {
              countdown--;
              if (countdown <= 0) {
                clearInterval(interval);
                window.location.href = "/";
              } else {
                resultP.innerText = `${data.message}\nüîÅ Quay v·ªÅ trang ch·ªß sau ${countdown} gi√¢y...`;
              }
            }, 1000);
          } else {
            resultP.style.color = "red";
            resultP.innerText = "‚ùå " + data.message;
            verifyBtn.disabled = false;
          }
        })
        .catch(err => {
          resultP.style.color = "red";
          resultP.innerText = "‚ùå L·ªói k·∫øt n·ªëi: " + err;
          verifyBtn.disabled = false;
        });
    }

    function stopCamera() {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
        video.srcObject = null;
      }
      streamStarted = false;
      video.style.display = "none";
    }

    function quayLai() { window.history.back(); }

    window.addEventListener('beforeunload', stopCamera);
  </script>

</body>

</html>